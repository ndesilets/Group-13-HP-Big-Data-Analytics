WITH SESS_TIME_MOD AS

(
SELECT 
  A.MODULE,
  A.CLIENT_INFO,
  A.SQL_EXEC_START,
  A.SNAPSHOT_TS,
  A.STAT_NAME,
  A.SID,
  A.VALUE
FROM CAPSTONE_DEMO.SESS_TIME_MODEL_PX_SESS_HIST A
WHERE SQL_EXEC_START BETWEEN TO_DATE(20170427, 'yyyymmdd') AND TO_DATE(20170429, 'yyyymmdd')

),

TIME_PIVOT AS

(
SELECT
  *
FROM SESS_TIME_MOD
PIVOT (
      SUM(VALUE/1E6) AS SEC
      FOR STAT_NAME IN ('DB time' AS DB_TIME, 'sql execute elapsed time' AS ELAPSED_TIME, 'DB CPU' AS CPU_TIME)
      )
),

CPU_OVER_TIME AS

(
SELECT
  MODULE,
  CLIENT_INFO,
  SQL_EXEC_START,
  SNAPSHOT_TS,
  (COUNT(*) - 1)/2 AS DOP,
  CAPSTONE_DEMO.INTERVAL_TO_SEC(SNAPSHOT_TS - SQL_EXEC_START) AS RUN_TIME_SEC,
  SUM(DB_TIME_SEC) AS DB_TIME_SEC,
  SUM(CPU_TIME_SEC) AS CPU_TIME_SEC
FROM TIME_PIVOT A
GROUP BY
  MODULE,
  CLIENT_INFO,
  SQL_EXEC_START,
  SNAPSHOT_TS
)

SELECT
  A.MODULE,
  A.CLIENT_INFO,
  A.SQL_EXEC_START,
    CASE
    WHEN MODULE LIKE 'PART_BY_ID%' THEN 'ID'
    WHEN MODULE LIKE 'PART_BY_DAY%' THEN 'DATE'
    WHEN MODULE LIKE 'PART_BY_DATE%' THEN 'DATE'
    END AS PARTITION_SCHEME,
CASE
    WHEN MODULE LIKE '%NEW_DATA%' THEN 'NO-DUPES'
    WHEN MODULE LIKE '%OVERLAP%' THEN 'DUPLICATES'
    END AS DUPLICATES,
CASE
    WHEN MODULE LIKE '%_NP' THEN 'NON-PREFIXED'
    WHEN MODULE LIKE '%_P' THEN 'PREFIXED'
    WHEN MODULE LIKE '%_NOI' THEN 'NO-INDEX'
END AS INDEX_PREFIXING,
CASE
    WHEN MODULE LIKE '%_LNUI%' THEN 'LOCAL'
    WHEN MODULE LIKE '%_LUI%' THEN 'LOCAL'
    WHEN MODULE LIKE '%_NUI%' THEN 'GLOBAL'
    WHEN MODULE LIKE '%_UI%' THEN 'GLOBAL'
    WHEN MODULE LIKE '%_NOI%' THEN 'NO-INDEX'
    WHEN MODULE LIKE '%_PK%' THEN 'GLOBAL'
END AS INDEX_PARTITIONING,
CASE
    WHEN MODULE LIKE '%_UI%' THEN 'UNIQUE'
    WHEN MODULE LIKE '%_PK%' THEN 'PRIMARY-KEY'
    WHEN MODULE LIKE '%_NU%' THEN 'NON-UNIQUE'
    WHEN MODULE LIKE '%_NOI%' THEN 'NO-INDEX'
END AS INDEX_TYPE,
  MAX(A.SNAPSHOT_TS) AS SQL_EXEC_END,
  MAX(RUN_TIME_SEC) AS RUN_TIME_SEC,
  MAX(DB_TIME_SEC) AS DB_TIME_SEC,
  MAX(CPU_TIME_SEC) AS CPU_TIME_SEC
FROM CPU_OVER_TIME A
GROUP BY
  A.MODULE,
  A.CLIENT_INFO,
  A.SQL_EXEC_START;